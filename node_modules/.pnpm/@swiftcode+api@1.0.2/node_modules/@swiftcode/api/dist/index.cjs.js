"use strict";var t=require("node:https"),e=require("node:http"),n=require("node:url"),r=require("node:querystring"),i=require("prettier"),s=require("node:fs");require("node:child_process");var o=require("quicktype-core");const c={number:0,integer:0,int64:"string",int32:0,string:"string",undefined:void 0,boolean:!1,object:{},file:"#/definitions/File"};function a(t){try{const e=JSON.parse(t);if("[object Object]"===Object.prototype.toString.call(e))return!0}catch(t){return!1}return!1}function f(t,e,n=!1){try{s.existsSync(t)||(s.mkdirSync(t),!n&&t.startsWith("temp")||console.log(`[SUCCESS] 创建 ${t} 文件夹成功`)),e&&e()}catch(e){throw Error(`[ERROR] 创建 ${t} 文件夹失败`)}}function u(t,e,n=!1){try{s.writeFileSync(t,e),!n&&t.startsWith("temp")||console.log(`[SUCCESS] 创建 ${t} 文件成功`)}catch(t){throw Error(`[ERROR] ${t}`)}}function l(t){try{return s.readFileSync(t,{encoding:"utf-8"})}catch(t){throw Error(`[ERROR] ${t}`)}}function p(t){s.existsSync(t)&&(s.readdirSync(t).forEach((e=>{const n=`${t}/${e}`;s.statSync(n).isDirectory()?p(n):s.unlinkSync(n)})),s.rmdirSync(t))}let d={};async function y(t,e){d=e;const n=function(t){var e;const n=new Map,r=t.paths,i=t.tags;for(const t of i)n.set(null!==(e=null==t?void 0:t.name)&&void 0!==e?e:Math.random().toFixed(1),{...t,path:{}});for(const t in r){const e=r[t],i=Object.keys(e);for(const r of i){const i=e[r],s=i&&Object.keys(i).length&&i.tags;for(const r of s){const i=n.get(r);if(i){const s=i.path;Object.assign(s,{[t]:e}),n.set(r,Object.assign(i,{path:s}))}}}}return function(t){const e=Object.create(null);for(let[n,r]of t)e[n]=r;return e}(n)}(t),r=function(t){for(let e in t)m(t[e]);return t}(n);return r}function m(t){t.pathFormat={};for(let[e,n]of Object.entries(t.path)){const r={};if(n)for(let[t,i]of Object.entries(n))Object.assign(r,{pathUrl:e,method:t,summary:i.summary,responsesType:g(i),requestType:O(i)});Object.assign(t.pathFormat,{[e]:r})}}function g(t){let e={};const n=t.responses[200].schema;if(null==n?void 0:n.$ref){e=v(n.$ref,d)}if(null==n?void 0:n.type){let t=n.type;"integer"===t&&n.format&&(t=n.format),e=t&&Object.keys(c).includes(t)?c[t]:t}return e}function O(t){var e,n;const r=t.parameters,i=Array.isArray(r)&&r.length&&r[0].in,s={};if("query"===i)for(let t of r){let e=t.type;"integer"===e&&t.format&&(e=t.format),Object.assign(s,{[t.name]:c[e]})}if("body"===i)for(let t of r){const r=t.schema&&t.schema.$ref;if(r)Object.assign(s,{[t.name]:v(r,d)}),Object.assign(s,{refname:S(r)});else if(t.schema&&"array"===t.schema.type){const r=t.schema;let i=r.items&&r.items.type;r.items||Object.assign(s,{[t.name]:[]}),"integer"===i&&(null===(e=null==r?void 0:r.items)||void 0===e?void 0:e.format)&&(i=r.items.format),i&&Object.keys(c).includes(i)&&Object.assign(s,{[t.name]:[c[i]]}),(null===(n=null==r?void 0:r.items)||void 0===n?void 0:n.$ref)&&(Object.assign(s,{[t.name]:v(r.items.$ref,d)}),Object.assign(s,{refname:S(r.items.$ref)}))}}if("formData"===i)for(let t of r){let e=null,n=t.type;"integer"===n&&t.format&&(n=t.format),e=Object.keys(c).includes(n)?"file"===n?"#File":c[n]:n,Object.assign(s,{[t.name]:e})}return s}function h(t){for(let e in t)b(t[e]);for(let e in t)j(t[e],t);return t}function b(t){var e;const n=t.properties,r={};if(n){for(let[t,i]of Object.entries(n)){if(i.type){if("array"===i.type){const n=i.items&&i.items.type;if(i.items||Object.assign(r,{[t]:[]}),n&&Object.keys(c).includes(n)){let e=n;"integer"===n&&i.items.format&&(e=i.items.format),Object.assign(r,{[t]:[c[e]]})}(null===(e=null==i?void 0:i.items)||void 0===e?void 0:e.$ref)&&Object.assign(r,{[t]:i.items.$ref})}if(Object.keys(c).includes(i.type)){let e=i.type;"integer"===e&&i.format&&(e=i.format),Object.assign(r,{[t]:c[e]})}}(null==i?void 0:i.$ref)&&Object.assign(r,{[t]:i.$ref})}Object.assign(t,{definition:r})}}function j(t,e){var n;const r=t.definition;if(r)for(let i in r){const s=r[i],o="#/definitions/";let c="";if("string"==typeof s&&s.includes(o)&&"#/definitions/File"!==s&&t.title!==s.split(o)[1]){c=s.split(o)[1];let t={};try{t=(null===(n=null==e?void 0:e[c])||void 0===n?void 0:n.definition)&&JSON.parse(JSON.stringify(e[c].definition))}catch(t){console.log(`异常值${e[c].definition}`,t)}Object.assign(r,{[i]:t})}}}function v(t,e){const n=S(t);return{[n]:e[n]&&e[n].definition}}function S(t){if(!t)return"";const e="#/definitions/";let n=t;return t.includes(e)&&(n=t.split(e)[1]),n}async function $(t){const e="typescript",n=o.jsonInputForTargetLanguage(e);await n.addSource({name:"output",samples:[t]});const r=new o.InputData;r.addInput(n);const{lines:i}=await o.quicktype({inputData:r,lang:e,indentation:"  ",inferEnums:!1,allPropertiesOptional:!0,rendererOptions:{"just-types":"true"}});return i.join("\n")}async function w(i){var s;let o=null;if("[object Object]"!==Object.prototype.toString.call(i))throw Error("请传入对象形式");const{type:c,source:f}=i;if("json"===c){if(!f)throw Error("请传入文件路径");const t=l(`${function(t){if("string"!=typeof t)throw Error("文件名请传入字符串格式");return t.startsWith("/")?t.slice(1):t}(f)}`);if(!a(t))throw Error("文件内容不是 JSON 格式！");const{tags:e,paths:n,definitions:r}=null!==(s=JSON.parse(t))&&void 0!==s?s:{};if(!e||!n||!r)throw Error("文档格式不支持，请传入 swagger json 文档");o=JSON.parse(t)}if("url"===c){if(!f.startsWith("https")&&!f.startsWith("http"))throw Error("[ERROR] 地址不支持，请传入完整请求地址");{try{o=await async function(i){try{return await function(i){const{url:s,method:o="get",data:c={},headers:f={}}=i,u=n.urlToHttpOptions(new URL(s)),l=r.stringify(c),p="https:"===u.protocol?t.request:e.request,d={...u,method:o,headers:f};return"[object Object]"===Object.prototype.toString.call(c)&&Object.values(c).length&&Object.assign(d,{search:l}),new Promise(((t,e)=>{const n=p(d,(n=>{n.setEncoding("utf8");let r="";n.on("data",(t=>r+=t)),n.on("end",(()=>{200===n.statusCode&&t(a(r)?JSON.parse(r):r),404===n.statusCode&&e("404 找不到请求的资源");const i=a(r)?JSON.parse(r):r;"[object Object]"===Object.prototype.toString.call(i)&&Object.values(i).length&&e(i.message||i),e(r)}))}));"post"===o&&n.write(l),n.on("error",(t=>{e(t)})),n.end()}))}(i)}catch(t){throw Error(`${(null==t?void 0:t.message)?t.message:t}`)}}({url:f})}catch(t){throw Error(`[ERROR] ${t}`)}const{tags:i,paths:s,definitions:c}=null!=o?o:{};if(!i||!s||!c)throw Error("[ERROR] 格式不支持，请传入 swagger json 文档")}}return o}function R(t,e,n){const r=t.indexOf("»»");if(t.slice(r),"HttpResult"===t)return"interfaceName"===e?"Record<string, never>":"";if(t.startsWith("HttpResult«List«")){const n=t.split("HttpResult«List«").join("").split("»»")[0];let r="";const i={"»»»»»":"»»»","»»»»":"»»","»»»":"»","»»":""};for(const e of Object.keys(i))if(t.includes(e)){r=n+i[e];break}return"interfaceName"===e?`T.${r}[]`:r}return"interfaceName"===e?`T.'${t}'`:t}function T(t,e){let n=`// ${t.description}\nimport http from '@/utils/http'\nimport { ERP_PLATFORM } from '@/constants/service'\nimport type * as T from './types'\nimport type { PageList } from '@/types'\n`;const r=[];for(const[e,i]of Object.entries(t.pathFormat)){let t=e.replace(/\//g,""),s="";i.requestType.refname?(s=R(i.requestType.refname,"interfaceName"),r.push(R(i.requestType.refname))):s="object"==typeof i.requestType&&Object.keys(i.requestType).length?JSON.stringify(i.requestType):"Record<string, never>";let o="";if("object"==typeof i.responsesType)if(Object.keys(i.responsesType).length){const t=Object.keys(i.responsesType)[0];o=R(t,"interfaceName"),r.push(R(t))}else o="Record<string, never>";["array","string"].includes(i.responsesType)&&(o="any"),n=n+`\n// ${i.summary}\nexport const ${t} = http.${i.method}<${s}, ${o}>(`+("`${ERP_PLATFORM}"+i.pathUrl+"`)\n")}const i=[...new Set(r)],s=a(e)?JSON.parse(e):{},o={};for(const t of i)s[t]&&Object.assign(o,{[t]:s[t]});return{content:n,definitions:JSON.stringify(o,void 0,2)}}async function E(t){const{target:e,dir:n="dist",isDev:r}=null!=t?t:{};if(!e)throw Error("输入为空");const s=h(e.definitions),o=function(t,e="data"){return`const ${e} = ${JSON.stringify(t,void 0,2)};\n\nexport { ${e} }`}(s,"definitions"),c=JSON.stringify(function(t){const e=h(t),n={};for(const[t,r]of Object.entries(e))Object.assign(n,{[t]:r.definition});return n}(e.definitions),void 0,2);try{await $(c)}catch(t){console.log("[ERROR] JSON 转换为 TypeScript 失败",t)}return f(n,(async()=>{const t=`${n}/definitions.js`;u(t,o,r);const e=await async function(t){const e=l(t);return await i.format(e,{filepath:t,tabWidth:2,useTabs:!1,printWidth:120,singleQuote:!0,semi:!1,trailingComma:"none",bracketSameLine:!0,endOfLine:"lf",htmlWhitespaceSensitivity:"css",vueIndentScriptAndStyle:!0})}(t);u(t,e)})),f("temp",(async()=>{u("temp/before-transform-ts.json",c,r)}),r),{definitionsContent:s,beforeTransformTs:c}}exports.Swagger2InterfaceOutput=async function(t){const{type:e="json",source:n,isDev:r=!1,dir:i="dist"}=t||{};p(i);const s=await w({type:e,source:n}),{definitionsContent:o,beforeTransformTs:c}=await E({target:s,dir:i,isDev:r});await async function(t){const{target:e,definitions:n,dir:r="dist",isDev:i,beforeTransformTs:s}=null!=t?t:{},o=await y(e,n);f("temp",(()=>{u("temp/whole-structure-content.json",JSON.stringify(o,void 0,2),i)}),i);for(let[t,e]of Object.entries(o)){const{content:n,definitions:o}=T(e,s),c=await $(o);f(`${r}`),f(`${r}/${t}`,(()=>{u(`${r}/${t}/index.ts`,n),u(`${r}/${t}/types.ts`,c)}),i)}}({target:s,definitions:o,beforeTransformTs:c,dir:i,isDev:r}),setTimeout((()=>{!r&&p("temp")}),300)};
