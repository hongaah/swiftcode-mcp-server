import t from"node:https";import e from"node:http";import{urlToHttpOptions as n}from"node:url";import r from"node:querystring";import i from"prettier";import s from"node:fs";import"node:child_process";import{jsonInputForTargetLanguage as o,InputData as c,quicktype as a}from"quicktype-core";const f={number:0,integer:0,int64:"string",int32:0,string:"string",undefined:void 0,boolean:!1,object:{},file:"#/definitions/File"};function l(t){try{const e=JSON.parse(t);if("[object Object]"===Object.prototype.toString.call(e))return!0}catch(t){return!1}return!1}function u(t,e,n=!1){try{s.existsSync(t)||(s.mkdirSync(t),!n&&t.startsWith("temp")||console.log(`[SUCCESS] 创建 ${t} 文件夹成功`)),e&&e()}catch(e){throw Error(`[ERROR] 创建 ${t} 文件夹失败`)}}function p(t,e,n=!1){try{s.writeFileSync(t,e),!n&&t.startsWith("temp")||console.log(`[SUCCESS] 创建 ${t} 文件成功`)}catch(t){throw Error(`[ERROR] ${t}`)}}function m(t){try{return s.readFileSync(t,{encoding:"utf-8"})}catch(t){throw Error(`[ERROR] ${t}`)}}function d(t){s.existsSync(t)&&(s.readdirSync(t).forEach((e=>{const n=`${t}/${e}`;s.statSync(n).isDirectory()?d(n):s.unlinkSync(n)})),s.rmdirSync(t))}let y={};async function g(t,e){y=e;const n=function(t){var e;const n=new Map,r=t.paths,i=t.tags;for(const t of i)n.set(null!==(e=null==t?void 0:t.name)&&void 0!==e?e:Math.random().toFixed(1),{...t,path:{}});for(const t in r){const e=r[t],i=Object.keys(e);for(const r of i){const i=e[r],s=i&&Object.keys(i).length&&i.tags;for(const r of s){const i=n.get(r);if(i){const s=i.path;Object.assign(s,{[t]:e}),n.set(r,Object.assign(i,{path:s}))}}}}return function(t){const e=Object.create(null);for(let[n,r]of t)e[n]=r;return e}(n)}(t),r=function(t){for(let e in t)O(t[e]);return t}(n);return r}function O(t){t.pathFormat={};for(let[e,n]of Object.entries(t.path)){const r={};if(n)for(let[t,i]of Object.entries(n))Object.assign(r,{pathUrl:e,method:t,summary:i.summary,responsesType:h(i),requestType:b(i)});Object.assign(t.pathFormat,{[e]:r})}}function h(t){let e={};const n=t.responses[200].schema;if(null==n?void 0:n.$ref){e=$(n.$ref,y)}if(null==n?void 0:n.type){let t=n.type;"integer"===t&&n.format&&(t=n.format),e=t&&Object.keys(f).includes(t)?f[t]:t}return e}function b(t){var e,n;const r=t.parameters,i=Array.isArray(r)&&r.length&&r[0].in,s={};if("query"===i)for(let t of r){let e=t.type;"integer"===e&&t.format&&(e=t.format),Object.assign(s,{[t.name]:f[e]})}if("body"===i)for(let t of r){const r=t.schema&&t.schema.$ref;if(r)Object.assign(s,{[t.name]:$(r,y)}),Object.assign(s,{refname:w(r)});else if(t.schema&&"array"===t.schema.type){const r=t.schema;let i=r.items&&r.items.type;r.items||Object.assign(s,{[t.name]:[]}),"integer"===i&&(null===(e=null==r?void 0:r.items)||void 0===e?void 0:e.format)&&(i=r.items.format),i&&Object.keys(f).includes(i)&&Object.assign(s,{[t.name]:[f[i]]}),(null===(n=null==r?void 0:r.items)||void 0===n?void 0:n.$ref)&&(Object.assign(s,{[t.name]:$(r.items.$ref,y)}),Object.assign(s,{refname:w(r.items.$ref)}))}}if("formData"===i)for(let t of r){let e=null,n=t.type;"integer"===n&&t.format&&(n=t.format),e=Object.keys(f).includes(n)?"file"===n?"#File":f[n]:n,Object.assign(s,{[t.name]:e})}return s}function j(t){for(let e in t)v(t[e]);for(let e in t)S(t[e],t);return t}function v(t){var e;const n=t.properties,r={};if(n){for(let[t,i]of Object.entries(n)){if(i.type){if("array"===i.type){const n=i.items&&i.items.type;if(i.items||Object.assign(r,{[t]:[]}),n&&Object.keys(f).includes(n)){let e=n;"integer"===n&&i.items.format&&(e=i.items.format),Object.assign(r,{[t]:[f[e]]})}(null===(e=null==i?void 0:i.items)||void 0===e?void 0:e.$ref)&&Object.assign(r,{[t]:i.items.$ref})}if(Object.keys(f).includes(i.type)){let e=i.type;"integer"===e&&i.format&&(e=i.format),Object.assign(r,{[t]:f[e]})}}(null==i?void 0:i.$ref)&&Object.assign(r,{[t]:i.$ref})}Object.assign(t,{definition:r})}}function S(t,e){var n;const r=t.definition;if(r)for(let i in r){const s=r[i],o="#/definitions/";let c="";if("string"==typeof s&&s.includes(o)&&"#/definitions/File"!==s&&t.title!==s.split(o)[1]){c=s.split(o)[1];let t={};try{t=(null===(n=null==e?void 0:e[c])||void 0===n?void 0:n.definition)&&JSON.parse(JSON.stringify(e[c].definition))}catch(t){console.log(`异常值${e[c].definition}`,t)}Object.assign(r,{[i]:t})}}}function $(t,e){const n=w(t);return{[n]:e[n]&&e[n].definition}}function w(t){if(!t)return"";const e="#/definitions/";let n=t;return t.includes(e)&&(n=t.split(e)[1]),n}async function R(t){const e="typescript",n=o(e);await n.addSource({name:"output",samples:[t]});const r=new c;r.addInput(n);const{lines:i}=await a({inputData:r,lang:e,indentation:"  ",inferEnums:!1,allPropertiesOptional:!0,rendererOptions:{"just-types":"true"}});return i.join("\n")}async function T(i){var s;let o=null;if("[object Object]"!==Object.prototype.toString.call(i))throw Error("请传入对象形式");const{type:c,source:a}=i;if("json"===c){if(!a)throw Error("请传入文件路径");const t=m(`${function(t){if("string"!=typeof t)throw Error("文件名请传入字符串格式");return t.startsWith("/")?t.slice(1):t}(a)}`);if(!l(t))throw Error("文件内容不是 JSON 格式！");const{tags:e,paths:n,definitions:r}=null!==(s=JSON.parse(t))&&void 0!==s?s:{};if(!e||!n||!r)throw Error("文档格式不支持，请传入 swagger json 文档");o=JSON.parse(t)}if("url"===c){if(!a.startsWith("https")&&!a.startsWith("http"))throw Error("[ERROR] 地址不支持，请传入完整请求地址");{try{o=await async function(i){try{return await function(i){const{url:s,method:o="get",data:c={},headers:a={}}=i,f=n(new URL(s)),u=r.stringify(c),p="https:"===f.protocol?t.request:e.request,m={...f,method:o,headers:a};return"[object Object]"===Object.prototype.toString.call(c)&&Object.values(c).length&&Object.assign(m,{search:u}),new Promise(((t,e)=>{const n=p(m,(n=>{n.setEncoding("utf8");let r="";n.on("data",(t=>r+=t)),n.on("end",(()=>{200===n.statusCode&&t(l(r)?JSON.parse(r):r),404===n.statusCode&&e("404 找不到请求的资源");const i=l(r)?JSON.parse(r):r;"[object Object]"===Object.prototype.toString.call(i)&&Object.values(i).length&&e(i.message||i),e(r)}))}));"post"===o&&n.write(u),n.on("error",(t=>{e(t)})),n.end()}))}(i)}catch(t){throw Error(`${(null==t?void 0:t.message)?t.message:t}`)}}({url:a})}catch(t){throw Error(`[ERROR] ${t}`)}const{tags:i,paths:s,definitions:c}=null!=o?o:{};if(!i||!s||!c)throw Error("[ERROR] 格式不支持，请传入 swagger json 文档")}}return o}function E(t,e,n){const r=t.indexOf("»»");if(t.slice(r),"HttpResult"===t)return"interfaceName"===e?"Record<string, never>":"";if(t.startsWith("HttpResult«List«")){const n=t.split("HttpResult«List«").join("").split("»»")[0];let r="";const i={"»»»»»":"»»»","»»»»":"»»","»»»":"»","»»":""};for(const e of Object.keys(i))if(t.includes(e)){r=n+i[e];break}return"interfaceName"===e?`T.${r}[]`:r}return"interfaceName"===e?`T.'${t}'`:t}function N(t,e){let n=`// ${t.description}\nimport http from '@/utils/http'\nimport { ERP_PLATFORM } from '@/constants/service'\nimport type * as T from './types'\nimport type { PageList } from '@/types'\n`;const r=[];for(const[e,i]of Object.entries(t.pathFormat)){let t=e.replace(/\//g,""),s="";i.requestType.refname?(s=E(i.requestType.refname,"interfaceName"),r.push(E(i.requestType.refname))):s="object"==typeof i.requestType&&Object.keys(i.requestType).length?JSON.stringify(i.requestType):"Record<string, never>";let o="";if("object"==typeof i.responsesType)if(Object.keys(i.responsesType).length){const t=Object.keys(i.responsesType)[0];o=E(t,"interfaceName"),r.push(E(t))}else o="Record<string, never>";["array","string"].includes(i.responsesType)&&(o="any"),n=n+`\n// ${i.summary}\nexport const ${t} = http.${i.method}<${s}, ${o}>(`+("`${ERP_PLATFORM}"+i.pathUrl+"`)\n")}const i=[...new Set(r)],s=l(e)?JSON.parse(e):{},o={};for(const t of i)s[t]&&Object.assign(o,{[t]:s[t]});return{content:n,definitions:JSON.stringify(o,void 0,2)}}async function k(t){const{target:e,dir:n="dist",isDev:r}=null!=t?t:{};if(!e)throw Error("输入为空");const s=j(e.definitions),o=function(t,e="data"){return`const ${e} = ${JSON.stringify(t,void 0,2)};\n\nexport { ${e} }`}(s,"definitions"),c=JSON.stringify(function(t){const e=j(t),n={};for(const[t,r]of Object.entries(e))Object.assign(n,{[t]:r.definition});return n}(e.definitions),void 0,2);try{await R(c)}catch(t){console.log("[ERROR] JSON 转换为 TypeScript 失败",t)}return u(n,(async()=>{const t=`${n}/definitions.js`;p(t,o,r);const e=await async function(t){const e=m(t);return await i.format(e,{filepath:t,tabWidth:2,useTabs:!1,printWidth:120,singleQuote:!0,semi:!1,trailingComma:"none",bracketSameLine:!0,endOfLine:"lf",htmlWhitespaceSensitivity:"css",vueIndentScriptAndStyle:!0})}(t);p(t,e)})),u("temp",(async()=>{p("temp/before-transform-ts.json",c,r)}),r),{definitionsContent:s,beforeTransformTs:c}}async function J(t){const{type:e="json",source:n,isDev:r=!1,dir:i="dist"}=t||{};d(i);const s=await T({type:e,source:n}),{definitionsContent:o,beforeTransformTs:c}=await k({target:s,dir:i,isDev:r});await async function(t){const{target:e,definitions:n,dir:r="dist",isDev:i,beforeTransformTs:s}=null!=t?t:{},o=await g(e,n);u("temp",(()=>{p("temp/whole-structure-content.json",JSON.stringify(o,void 0,2),i)}),i);for(let[t,e]of Object.entries(o)){const{content:n,definitions:o}=N(e,s),c=await R(o);u(`${r}`),u(`${r}/${t}`,(()=>{p(`${r}/${t}/index.ts`,n),p(`${r}/${t}/types.ts`,c)}),i)}}({target:s,definitions:o,beforeTransformTs:c,dir:i,isDev:r}),setTimeout((()=>{!r&&d("temp")}),300)}export{J as Swagger2InterfaceOutput};
